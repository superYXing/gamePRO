# 《完美医生》- AI 驱动的医患对话体验游戏

《完美医生》是一款革命性的医学互动体验游戏，结合了视觉小说的叙事魅力与最先进的人工智能技术。玩家将扮演医生，在智能AI助手的帮助下与AI患者进行真实的医患对话，体验医疗决策的复杂性和医患沟通的艺术。

## 🏥 项目概述

这是一个基于Ren'Py引擎开发的医学模拟游戏，旨在为医学生、医护人员以及对医学感兴趣的玩家提供沉浸式的医患交流体验。游戏融合了人工智能、语音合成、视觉小说等多项技术，创造出前所未有的互动医学教育平台。

### � 核心理念
- **真实性**：基于真实医疗场景设计，贴近临床实际
- **智能化**：AI驱动的对话系统，每次体验都独一无二
- **沉浸式**：实时语音合成，营造身临其境的医院氛围
- **教育性**：寓教于乐，提升医学知识和沟通技巧

## 🌟 核心功能

### 🤖 智能AI对话系统
- **双向AI驱动**：医生和患者均可由AI智能生成对话内容
- **上下文理解**：AI能够基于对话历史生成连贯、符合逻辑的回应
- **多样化风格**：支持不同性格特征的AI角色（理性、感性、中性等）
- **角色一致性**：每个AI角色都有独特的语言风格和行为模式

### 🎙️ 实时语音合成
- **OpenAI兼容TTS**：支持yunwu.ai等多种高质量语音合成服务
- **情感表达**：6种不同情感模式，自动识别对话情绪并调整语调
- **语速控制**：0.25x-4.0x的语速调节范围，适应不同用户需求
- **角色专属音色**：每个角色都有独特的声音特色
- **音频缓存**：智能音频文件管理，提升播放流畅度

### 🎮 沉浸式游戏体验
- **视觉小说界面**：精美的游戏画面和用户界面设计
- **互动式剧情**：玩家的选择直接影响故事发展方向
- **医院场景**：真实还原医院环境，包含诊室、病房等多个场景
- **角色系统**：丰富的医生、患者、护士等角色设定

### 🔧 技术特色
- **模块化架构**：清晰的代码结构，便于扩展和维护
- **配置管理**：统一的环境变量管理，安全便捷的API密钥配置
- **错误处理**：完善的异常处理机制，确保游戏稳定运行
- **跨平台支持**：基于Ren'Py引擎，支持Windows、Mac、Linux等平台

## 🏗️ 技术架构

### 核心技术栈
- **游戏引擎**：Ren'Py 8.4.1 - 专业的视觉小说开发框架
- **AI模型**：OpenAI Chat Completions API（gpt-4o-mini等）
- **语音合成**：OpenAI兼容TTS API（支持yunwu.ai等多个服务商）
- **网络通信**：HTTP/WebSocket客户端，支持异步请求
- **音频处理**：WAV/MP3格式支持，智能音频缓存
- **配置管理**：dotenv + 统一配置模块，安全的环境变量管理

### 系统架构
```
AI引擎层 ← → 游戏逻辑层 ← → 用户界面层
    ↓           ↓           ↓
语音合成     Ren'Py引擎    可视化界面
    ↓           ↓           ↓
音频播放     脚本执行     用户交互
```

## 📁 项目结构详解

```
《完美医生》/
├── game/                    # 游戏核心目录
│   ├── *.rpy               # Ren'Py游戏脚本
│   │   ├── script.rpy      # 主脚本文件
│   │   ├── day1.rpy        # 第一天剧情
│   │   ├── options.rpy     # 游戏配置
│   │   ├── gui.rpy         # 界面设置
│   │   └── screens.rpy     # 界面元素
│   ├── *.py                # Python模块
│   │   ├── config.py       # 统一配置管理
│   │   ├── ai_module.py    # AI对话核心
│   │   └── tts_module.py   # 语音合成模块
│   ├── audio/              # 音频资源
│   │   ├── bgm/           # 背景音乐
│   │   ├── sfx/           # 音效文件
│   │   └── tts/           # 生成的语音文件
│   ├── images/             # 图像资源
│   │   ├── backgrounds/    # 背景图片
│   │   ├── characters/     # 角色立绘
│   │   └── ui/            # 界面素材
│   ├── gui/               # 界面资源
│   └── python-packages/   # 第三方Python包
├── test/                   # 测试模块
│   ├── test_ai_manager.py # AI系统测试
│   └── quick_ai_test.py   # 快速功能测试
├── .env.example           # 环境变量模板
├── .env                   # 环境变量配置（需要用户创建）
└── README.md              # 项目说明文档
```

## 🎭 游戏角色与场景

### 主要角色
- **医生（玩家）**：主角，负责诊断和治疗决策
- **AI患者**：智能生成的虚拟患者，具有不同的性格和病情
- **AI助手**：为医生提供诊断建议和治疗方案
- **护士**：协助医疗过程，提供专业支持

### 游戏场景
- **门诊诊室**：日常门诊接诊场景
- **急诊科**：紧急医疗救治场景
- **病房**：住院患者管理场景
- **手术室**：外科手术决策场景

### 医疗场景
游戏涵盖多种常见医疗情况：
- 常见疾病的诊断与治疗
- 急诊病例的快速决策
- 慢性病的长期管理
- 医患沟通技巧训练

## 🚀 快速开始指南

### 环境要求
- **操作系统**：Windows 10/11, macOS 10.15+, 或 Linux（Ubuntu 18.04+）
- **Ren'Py版本**：8.4.1 或更高版本
- **Python版本**：3.8 或更高版本（Ren'Py内置）
- **网络连接**：用于AI API调用和语音合成

### 安装步骤

#### 1. 获取项目代码
```bash
# 克隆仓库
git clone https://github.com/superYXing/gamePRO.git
cd gamePRO/dlutHosGame

# 或直接下载ZIP文件并解压
```

#### 2. 配置API密钥和模型

项目采用统一的配置管理系统，通过`.env`文件安全管理API密钥。

**步骤：**
1. 复制配置模板：
   ```bash
   cp .env.example .env
   ```

2. 编辑`.env`文件，填入你的API配置：
   ```env
   # OpenAI兼容API配置
   OPENAI_BASE_URL=https://yunwu.ai/v1
   OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   
   # 语音合成配置
   OPENAI_TTS_MODEL=tts-1
   OPENAI_TTS_VOICE=alloy
   
   # AI对话模型配置
   MODEL_NAME=gpt-4o-mini
   ```

#### 3. 下载并安装Ren'Py
- 访问 [Ren'Py官网](https://www.renpy.org/latest.html) 下载最新版本
- 解压并运行Ren'Py启动器

#### 4. 导入项目
1. 打开Ren'Py启动器
2. 点击"偏好设置"，添加项目目录路径
3. 选择《完美医生》项目
4. 点击"启动项目"开始游戏

### API服务推荐

#### OpenAI兼容服务
- **yunwu.ai**：高质量、低延迟的国内AI服务
- **OpenAI官方**：原版ChatGPT API服务
- **Azure OpenAI**：微软云端AI服务
- **其他兼容服务**：支持OpenAI API格式的第三方服务

#### 获取API密钥
1. 访问你选择的AI服务提供商官网
2. 注册账户并完成身份验证
3. 在控制台创建API密钥
4. 将密钥填入`.env`文件

> **安全提示**：请妥善保管API密钥，不要将包含真实密钥的`.env`文件提交到版本控制系统。

## 🎮 游戏玩法指南

### 基础操作
- **对话选择**：点击屏幕下方的选项进行对话选择
- **AI辅助**：游戏会自动生成多种医生回复选项
- **语音播放**：对话文本会自动转换为语音播放
- **情绪识别**：AI会根据对话内容自动调整语音情感

### 游戏流程
1. **患者接诊**：了解患者基本情况和主诉
2. **病史询问**：通过AI生成的问题深入了解病情
3. **体格检查**：根据症状选择相应的检查项目
4. **诊断推理**：结合AI建议做出诊断判断
5. **治疗方案**：制定个性化的治疗计划
6. **随访管理**：跟踪治疗效果和患者满意度

### 评分系统
游戏会根据以下维度对玩家表现进行评分：
- **诊断准确性**：诊断是否正确和及时
- **沟通技巧**：与患者交流的有效性
- **治疗方案**：治疗选择的合理性
- **患者满意度**：患者对医疗服务的满意程度

# 对话模型
MODEL_NAME=gpt-4o-mini
```

## ❓ 常见问题（FAQ）

- Q: 第二轮开始报 500？
	- A: 确保传入 Chat Completions 的消息仅包含 `system/user/assistant` 三种角色。本项目已在 `ai_module.py` 中进行角色标准化与末条 user 校正。
- Q: TTS 无声或卡顿？
	- A: 检查音量通道（music/sound/voice），确认音频文件已生成到 `game/audio/tts/`。
- Q: 密钥未生效？
	- A: 确认 `.env` 位置（根目录或 game/），并确保未提交到版本库；`config.py` 会自动加载。

3) 代码中不要硬编码密钥。Ren'Py 脚本 `day1.rpy`、`script.rpy` 与 `ai_module.py` 已改为自动从 `config.py` 读取。

提示：`.env` 已在 `.gitignore` 中忽略，避免泄露密钥。

### 运行游戏

在 Ren'Py 启动器中选择项目并点击 "启动"。

## 🧪 测试

项目包含多个测试脚本：

- `test_tts_api.py`: 测试 TTS API 连接
- `test/test_ai_manager.py`: 测试 AI 管理器
- `quick_ai_test.py`: 快速 AI 测试

## 🛠️ 构建

使用 Ren'Py 启动器的 "构建" 功能生成发布版本。

## 🤝 贡献

欢迎提交 Issue 和 Pull Request。

## 📞 联系方式

- 项目主页：[GitHub Repository](https://github.com/your-username/PerfectDoctor)
- 问题反馈：[Issues](https://github.com/your-username/PerfectDoctor/issues)

---

**注意**：请遵守所使用 OpenAI 兼容服务的相关条款与配额限制。

## 🔄 更新日志

### v1.2.0 (2025-08-19)
- ✅ 集中化配置（config.py + .env），移除硬编码密钥
- ✅ AI 患者对话角色标准化，避免 500 错误
- ✅ README 重构，补充快速上手与 FAQ

### v1.1.0 (2025-08-18)
- ✅ 新增 OpenAI 兼容 TTS（yunwu.ai 等）
- ✅ 环境变量配置与安全指引
- ✅ 文档与模板更新
