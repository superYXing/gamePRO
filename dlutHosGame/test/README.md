# AI Manager 测试说明

本目录包含用于测试 AI Manager 功能的测试文件。

## 测试文件说明

### 1. `test_ai_manager.py` - 完整测试
**功能**: 全面测试 AI 管理器的所有功能
- AI 管理器初始化测试
- SAN 值计算逻辑测试
- AI 回复生成测试（支持离线模式）
- 回退机制测试
- 网络连接状态检测

**运行方式**:
```bash
cd test
python test_ai_manager.py
```

### 2. `quick_ai_test.py` - 快速测试
**功能**: 快速验证 AI 模块基本功能
- 基本导入和初始化测试
- SAN 值计算验证
- 简单网络连接测试

**运行方式**:
```bash
cd test  
python quick_ai_test.py
```

### 3. `run_ai_test.bat` - Windows 批处理
**功能**: Windows 环境下一键运行完整测试
- 自动切换到正确目录
- 运行完整测试
- 测试完成后暂停

**运行方式**:
双击 `run_ai_test.bat` 文件

## 测试内容

### AI Manager 初始化测试
- ✅ 验证 API Key 配置
- ✅ 验证 Base URL 设置
- ✅ 验证初始 SAN 值（100）
- ✅ 验证 httpx 客户端创建

### SAN 值计算测试
- ✅ 理性选择：-5 SAN
- ✅ 人性选择：-2 SAN  
- ✅ 平淡选择：-10 SAN
- ✅ 未知类型：-5 SAN（默认值）
- ✅ SAN 值范围限制（0-100）

### AI 回复生成测试
- ✅ 不同选择类型的 prompt 调整
- ✅ 网络请求处理
- ✅ 错误处理和异常捕获
- ✅ API 响应解析

### 回退机制测试
- ✅ 预设回复文本验证
- ✅ 网络故障时的回退逻辑
- ✅ API 错误时的回退逻辑

## 预期结果

### 正常情况（网络可用）
```
✓ AI 管理器初始化成功
✓ SAN 值计算正确
✓ 网络连接正常
✓ AI 回复生成成功
```

### 网络不可用情况
```
✓ AI 管理器初始化成功
✓ SAN 值计算正确
✗ 网络连接失败
○ AI 回复生成失败（使用预设回复）
```

## 故障排除

### 导入错误
如果出现 `Import "ai_module" could not be resolved` 错误：
- 确保在 `test` 目录下运行测试
- 确保 `game/ai_module.py` 文件存在
- 检查 Python 路径设置

### 网络连接错误
如果网络测试失败：
- 检查互联网连接
- 检查防火墙设置
- 检查代理配置
- 这不会影响游戏运行（会使用预设回复）

### API 调用错误
如果 AI API 调用失败：
- 检查 API Key 是否有效
- 检查 yunwu.ai 服务状态
- 检查 API 配额和限制
- 游戏会自动使用预设回复

## 测试数据

测试使用的示例患者问题：
1. "患者主诉：焦虑和失眠"
2. "患者主诉：头痛持续一周"  
3. "患者主诉：胃痛和恶心"

每个问题会测试三种医生回应风格：
- 理性分析
- 人性关怀
- 普通建议

## 注意事项

1. **网络依赖**: AI 回复生成需要网络连接，但游戏有完整的离线回退机制
2. **API 限制**: 如果频繁测试可能触发 API 限制，属正常情况
3. **测试环境**: 测试在独立环境中运行，不会影响游戏存档
4. **日志输出**: 测试会产生详细日志，帮助诊断问题

---

**最后更新**: 2025-08-18  
**作者**: GitHub Copilot
